<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Changemaker Dost</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand-blue: #0d6efd;
            --background-color: #f8f9fa;
            --text-color: #212529;
            --light-text-color: #6c757d;
            --user-message-bg: #e9ecef;
            --bot-message-bg: #ffffff;
            --dashboard-green: #28a745;
        }

        /* --- Basic Reset & Body --- */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* --- Main Chat Application Layout --- */
        .chat-container {
            width: 100%;
            height: 100%;
            max-width: 800px; /* Max width for desktop for readability */
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            background: var(--background-color);
            border-radius: 8px; /* Subtle rounding on desktop */
            overflow: hidden; /* Ensures children conform to border-radius */
        }
        
        /* --- Chat Header --- */
        .chat-header {
            background-color: var(--brand-blue);
            color: white;
            padding: 1rem 1.5rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            flex-shrink: 0; /* Prevents header from shrinking */
        }

        /* --- Message Area --- */
        .chat-messages {
            flex-grow: 1; /* Takes up all available space */
            overflow-y: auto; /* Enables scrolling for messages */
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        /* --- Initial Welcome Screen --- */
        #welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100%;
        }
        #welcome-screen h1 {
            font-family: 'Playfair Display', serif; /* A more premium, distinct font */
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        #welcome-screen p {
            font-size: 1.15rem;
            color: var(--light-text-color);
            max-width: 450px;
            line-height: 1.6;
        }
        
        /* --- Individual Message Bubbles --- */
        .message {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            margin-bottom: 0.75rem;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .message.user {
            background-color: var(--user-message-bg);
            color: var(--text-color);
            align-self: flex-end; /* Aligns to the right */
            border-bottom-right-radius: 4px;
        }
        .message.bot {
            background-color: var(--bot-message-bg);
            border: 1px solid #e9ecef;
            align-self: flex-start; /* Aligns to the left */
            border-bottom-left-radius: 4px;
        }

        /* --- Suggestion Chips --- */
        .suggestion-chips {
            align-self: flex-start;
            margin-bottom: 0.75rem;
        }
        .chip {
            display: inline-block;
            background: none;
            border: 1px solid var(--brand-blue);
            color: var(--brand-blue);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        .chip:hover {
            background-color: var(--brand-blue);
            color: white;
        }

        /* --- Input Area --- */
        .chat-input-area {
            flex-shrink: 0; /* Prevents input area from shrinking */
            padding: 1rem 1.5rem;
            background-color: #ffffff;
            border-top: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        #text-input {
            flex-grow: 1;
            border: none;
            background: var(--user-message-bg);
            padding: 0.85rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            outline: none;
        }
        .icon-button {
            background-color: var(--brand-blue);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            color: white; /* For the SVG icon color */
        }
        .icon-button:hover {
            transform: scale(1.1);
        }
        .icon-button#dashboard-button {
            background-color: var(--dashboard-green);
        }
        .icon-button svg {
            width: 24px;
            height: 24px;
        }

        /* --- THIS IS THE KEY: We hide the original widget UI --- */
        df-messenger {
            display: none !important;
        }

    </style>
</head>
<body>

    <div class="chat-container">
        <header class="chat-header">
            Changemaker Dost
        </header>

        <main class="chat-messages" id="chat-messages">
            <div id="welcome-screen">
                <h1>Iâ€™m your Changemaker Dost.</h1>
                <p>You can ask me anything about Ashoka, or we can start your CMI assessment.</p>
            </div>
        </main>

        <footer class="chat-input-area">
            <input type="text" id="text-input" placeholder="Type your message...">
            
            <button class="icon-button" id="dashboard-button" title="Dashboard">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M4 13h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zm0 8h6c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1zm10 0h6c.55 0 1-.45 1-1v-8c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zM13 4v4c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1z"/></svg>
            </button>
            
            <button class="icon-button" id="send-button" title="Send">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
            </button>
        </footer>
    </div>

    <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
    <df-messenger
      agent-id="37266707-5fe3-47f1-af94-aeb4f3768cf1"
      language-code="en"
      location="asia-south1"
    ></df-messenger>

    <script>
        // --- DOM Element References ---
        const dfMessenger = document.querySelector('df-messenger');
        const chatMessages = document.getElementById('chat-messages');
        const textInput = document.getElementById('text-input');
        const sendButton = document.getElementById('send-button');
        const welcomeScreen = document.getElementById('welcome-screen');

        let isConversationStarted = false;

        // --- Core Function: Add a message to the chat UI ---
        function addMessage(text, type) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', type); // type is 'user' or 'bot'
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            // Scroll to the bottom to see the new message
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- Core Function: Add suggestion chips to the UI ---
        function addSuggestionChips(chips) {
            const chipsContainer = document.createElement('div');
            chipsContainer.classList.add('suggestion-chips');

            chips.forEach(chipInfo => {
                const chip = document.createElement('button');
                chip.classList.add('chip');
                chip.textContent = chipInfo.text;
                chip.addEventListener('click', () => {
                    handleSendMessage(chipInfo.text);
                    // Remove chips after one is clicked
                    chipsContainer.remove(); 
                });
                chipsContainer.appendChild(chip);
            });
            chatMessages.appendChild(chipsContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // --- Core Function: Send a message ---
        function handleSendMessage(queryText) {
            const text = queryText || textInput.value.trim();
            if (!text) return;

            // Hide welcome screen on first message
            if (!isConversationStarted) {
                welcomeScreen.style.display = 'none';
                isConversationStarted = true;
            }

            // Display user's message in our custom UI
            addMessage(text, 'user');
            
            // Use the hidden df-messenger to send the request
            dfMessenger.sendRequest('text', text);

            // Clear the input field
            textInput.value = '';
        }

        // --- Event Listener for Dialogflow's Response ---
        dfMessenger.addEventListener('df-messenger-response-received', function (event) {
            const responses = event.detail.responses;

            responses.forEach(response => {
                if (response.text) {
                    addMessage(response.text.text.join('\n'), 'bot');
                }
                if (response.payload && response.payload.richContent) {
                    const richContent = response.payload.richContent[0];
                    richContent.forEach(item => {
                        if (item.type === 'chips') {
                            addSuggestionChips(item.options);
                        }
                    });
                }
            });
        });
        
        // --- Event Listener for the Dialogflow widget being ready ---
        dfMessenger.addEventListener('df-messenger-loaded', function (event) {
            // Function to get or create a persistent user ID from localStorage
            function getOrCreateUserId() {
                let userId = localStorage.getItem('changemakerDost_userId');
                if (!userId) {
                    userId = 'user_' + Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('changemakerDost_userId', userId);
                }
                return userId;
            }

            const persistentUserId = getOrCreateUserId();
            dfMessenger.setAttribute('session-id', persistentUserId);
            console.log('Persistent User ID set:', persistentUserId);
        });

        // --- User Input Event Listeners ---
        sendButton.addEventListener('click', () => handleSendMessage());
        textInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleSendMessage();
            }
        });

    </script>
</body>
</html>